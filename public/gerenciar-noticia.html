<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Notícia - Byte Bros.TI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-dark">

    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card bg-dark text-light border-secondary">
                    <div class="card-header">
                        <h2 id="form-title">Adicionar Nova Notícia</h2>
                    </div>
                    <div class="card-body">
                        <form id="news-form">
                            <input type="hidden" id="news-id">
                            
                            <div class="mb-3">
                                <label for="news-title" class="form-label">Título</label>
                                <input type="text" class="form-control" id="news-title" required>
                            </div>

                            <div class="mb-3">
                                <label for="news-subtitle" class="form-label">Subtítulo (Opcional)</label>
                                <input type="text" class="form-control" id="news-subtitle">
                            </div>

                            <div class="mb-3">
                                <label for="news-content" class="form-label">Conteúdo da Notícia</label>
                                <textarea class="form-control" id="news-content" rows="6" required></textarea>
                            </div>

                             <div class="mb-3">
                                <label for="news-reference" class="form-label">Fonte da Matéria / Referência (Opcional)</label>
                                <input type="text" class="form-control" id="news-reference" placeholder="Ex: https://www.exemplo.com/noticia">
                            </div>
                            
                            <div class="mb-3">
                                <label for="news-image" class="form-label">Imagem da Notícia (Opcional)</label>
                                <input class="form-control" type="file" id="news-image" accept="image/png, image/jpeg, image/webp">
                                <small class="form-text text-muted">A imagem atual será mantida se nenhuma nova for selecionada.</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="news-image-reference" class="form-label">Fonte da Imagem (Opcional)</label>
                                <input type="text" class="form-control" id="news-image-reference" placeholder="Ex: Nome do fotógrafo ou link da imagem">
                            </div>
                            
                            <div id="image-preview-container" class="mb-3 d-none">
                                <p>Imagem Atual:</p>
                                <img id="image-preview" src="" alt="Imagem da notícia" class="img-fluid rounded" style="max-height: 200px;">
                            </div>
                            
                            <div id="form-error" class="alert alert-danger d-none"></div>

                            <div class="d-flex justify-content-between">
                                <a href="ADM.html" class="btn btn-secondary">Cancelar</a>
                                <button type="submit" id="save-button" class="btn btn-primary">Salvar Notícia</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './js/supabase-client.js';

        const form = document.getElementById('news-form');
        const formTitle = document.getElementById('form-title');
        const newsIdField = document.getElementById('news-id');
        const newsTitleField = document.getElementById('news-title');
        const newsSubtitleField = document.getElementById('news-subtitle');
        const newsContentField = document.getElementById('news-content');
        const newsReferenceField = document.getElementById('news-reference');
        const newsImageField = document.getElementById('news-image');
        const newsImageReferenceField = document.getElementById('news-image-reference'); // NOVA VARIÁVEL
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const saveButton = document.getElementById('save-button');
        const formError = document.getElementById('form-error');

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        let existingImageUrl = null;
        let currentAdminName = null;

        async function checkUserAndLoadData() {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) {
                alert("Acesso negado. Faça o login como administrador.");
                window.location.href = 'ADM.html';
                return;
            }

            const { data: userProfile } = await supabase.from('usuarios').select('nome_completo').eq('id', session.user.id).single();
            currentAdminName = userProfile?.nome_completo || 'Admin';

            if (editId) {
                loadNewsForEdit();
            }
        }


        async function loadNewsForEdit() {
            formTitle.textContent = 'Editar Notícia';
            newsIdField.value = editId;

            const { data, error } = await supabase.from('noticias').select('*').eq('id', editId).single();

            if (error) {
                formError.textContent = 'Erro ao carregar notícia: ' + error.message;
                formError.classList.remove('d-none');
                return;
            }

            newsTitleField.value = data.titulo;
            newsSubtitleField.value = data.subtitulo;
            newsContentField.value = data.conteudo;
            newsReferenceField.value = data.referencia;
            newsImageReferenceField.value = data.imagem_referencia; // CARREGA O NOVO CAMPO
            
            if (data.imagem) {
                existingImageUrl = data.imagem;
                imagePreview.src = data.imagem;
                imagePreviewContainer.classList.remove('d-none');
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.classList.add('d-none');
            saveButton.disabled = true;
            saveButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Salvando...`;

            try {
                let imageUrl = existingImageUrl;
                const file = newsImageField.files[0];

                if (file) {
                    const filePath = `public/noticias/${Date.now()}-${file.name}`;
                    const { error: uploadError } = await supabase.storage.from('imagensgerais').upload(filePath, file);

                    if (uploadError) throw uploadError;

                    const { data: urlData } = supabase.storage.from('imagensgerais').getPublicUrl(filePath);
                    imageUrl = urlData.publicUrl;
                }
                
                const newsData = {
                    titulo: newsTitleField.value,
                    subtitulo: newsSubtitleField.value,
                    conteudo: newsContentField.value,
                    referencia: newsReferenceField.value,
                    imagem: imageUrl,
                    imagem_referencia: newsImageReferenceField.value, // SALVA O NOVO CAMPO
                    autor: currentAdminName,
                    data: new Date().toISOString(),
                };

                let response;
                if (editId) {
                    response = await supabase.from('noticias').update(newsData).eq('id', editId);
                } else {
                    response = await supabase.from('noticias').insert([newsData]);
                }

                if (response.error) throw response.error;

                alert('Notícia salva com sucesso!');
                window.location.href = 'ADM.html';

            } catch (error) {
                formError.textContent = error.message;
                formError.classList.remove('d-none');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Salvar Notícia';
            }
        });

        checkUserAndLoadData();
    </script>

</body>
</html>