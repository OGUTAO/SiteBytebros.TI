<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Produto - Byte Bros.TI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-dark">

    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card bg-dark text-light border-secondary">
                    <div class="card-header">
                        <h2 id="form-title">Adicionar Novo Produto</h2>
                    </div>
                    <div class="card-body">
                        <form id="product-form">
                            <input type="hidden" id="product-id">
                            
                            <div class="mb-3">
                                <label for="product-name" class="form-label">Nome do Produto</label>
                                <input type="text" class="form-control" id="product-name" required>
                            </div>

                            <div class="mb-3">
                                <label for="product-details" class="form-label">Descrição Curta</label>
                                <textarea class="form-control" id="product-details" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="product-specs" class="form-label">Especificações Técnicas</label>
                                <textarea class="form-control" id="product-specs" rows="6" placeholder="Ex:&#10;Marca: Exemplo&#10;Modelo: XPTO-123&#10;Memória RAM: 16GB DDR4"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="product-value" class="form-label">Preço (R$)</label>
                                    <input type="number" class="form-control" id="product-value" step="0.01" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="product-quantity" class="form-label">Estoque (Quantidade)</label>
                                    <input type="number" class="form-control" id="product-quantity" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="product-image" class="form-label">Imagem Principal do Produto</label>
                                <input class="form-control" type="file" id="product-image" accept="image/png, image/jpeg, image/webp">
                                <small class="form-text text-muted">Esta será a imagem de capa. A imagem atual será mantida se nenhuma nova for selecionada.</small>
                            </div>
                            
                            <div id="image-preview-container" class="mb-3 d-none">
                                <p>Imagem Principal Atual:</p>
                                <img id="image-preview" src="" alt="Imagem do produto" class="img-fluid rounded" style="max-height: 200px;">
                            </div>

                            <div class="mb-3">
                                <label for="product-gallery-upload" class="form-label">Adicionar Imagens à Galeria</label>
                                <input class="form-control" type="file" id="product-gallery-upload" accept="image/png, image/jpeg, image/webp" multiple>
                                <small class="form-text text-muted">Selecione uma ou mais imagens para a galeria do produto. As imagens atuais serão mantidas.</small>
                            </div>
                            
                            <div id="gallery-preview-container" class="mb-3">
                                <p>Imagens da Galeria Atual:</p>
                                <div id="gallery-preview" class="d-flex flex-wrap gap-2">
                                    </div>
                            </div>
                            <div id="form-error" class="alert alert-danger d-none"></div>

                            <div class="d-flex justify-content-between">
                                <a href="ADM.html" class="btn btn-secondary">Cancelar</a>
                                <button type="submit" id="save-button" class="btn btn-primary">Salvar Produto</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './js/supabase-client.js';

        const form = document.getElementById('product-form');
        const formTitle = document.getElementById('form-title');
        const productIdField = document.getElementById('product-id');
        const productNameField = document.getElementById('product-name');
        const productDetailsField = document.getElementById('product-details');
        const productSpecsField = document.getElementById('product-specs');
        const productValueField = document.getElementById('product-value');
        const productQuantityField = document.getElementById('product-quantity');
        const productImageField = document.getElementById('product-image');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const saveButton = document.getElementById('save-button');
        const formError = document.getElementById('form-error');

        // ALTERADO: Referências aos novos elementos do HTML
        const productGalleryUploadField = document.getElementById('product-gallery-upload');
        const galleryPreviewContainer = document.getElementById('gallery-preview-container');
        const galleryPreview = document.getElementById('gallery-preview');

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        let existingImageUrl = null;
        let existingGalleryUrls = []; // ALTERADO: Variável para guardar as URLs da galeria existentes

        async function loadProductForEdit() {
            if (!editId) {
                galleryPreviewContainer.classList.add('d-none'); // Esconde a prévia da galeria se for um novo produto
                return;
            };

            formTitle.textContent = 'Editar Produto';
            productIdField.value = editId;

            const { data, error } = await supabase.from('produtos').select('*').eq('id', editId).single();

            if (error) {
                formError.textContent = 'Erro ao carregar produto: ' + error.message;
                formError.classList.remove('d-none');
                return;
            }

            productNameField.value = data.name;
            productDetailsField.value = data.details;
            productSpecsField.value = data.especificacoes;
            productValueField.value = data.value;
            productQuantityField.value = data.quantity;
            
            if (data.image) {
                existingImageUrl = data.image;
                imagePreview.src = data.image;
                imagePreviewContainer.classList.remove('d-none');
            }
            
            // ALTERADO: Lógica para exibir as imagens da galeria existentes
            if (data.imagens && data.imagens.length > 0) {
                existingGalleryUrls = data.imagens;
                galleryPreview.innerHTML = ''; // Limpa a prévia antes de adicionar as imagens
                existingGalleryUrls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = "Imagem da galeria";
                    img.className = "img-thumbnail";
                    img.style.height = '100px';
                    img.style.width = '100px';
                    img.style.objectFit = 'cover';
                    galleryPreview.appendChild(img);
                });
            } else {
                galleryPreviewContainer.classList.add('d-none'); // Esconde se não houver imagens na galeria
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            formError.classList.add('d-none');
            saveButton.disabled = true;
            saveButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Salvando...`;

            try {
                // 1. Processa a imagem principal (lógica mantida)
                let imageUrl = existingImageUrl;
                const mainImageFile = productImageField.files[0];

                if (mainImageFile) {
                    const filePath = `public/${Date.now()}-${mainImageFile.name}`;
                    const { error: uploadError } = await supabase.storage.from('imagensprodutos').upload(filePath, mainImageFile);
                    if (uploadError) throw uploadError;
                    const { data: urlData } = supabase.storage.from('imagensprodutos').getPublicUrl(filePath);
                    imageUrl = urlData.publicUrl;
                }
                
                // 2. ALTERADO: Processa as novas imagens da galeria
                const galleryFiles = productGalleryUploadField.files;
                let newUploadedUrls = [];

                if (galleryFiles.length > 0) {
                    // Cria um array de promessas de upload para executar em paralelo
                    const uploadPromises = Array.from(galleryFiles).map(file => {
                        const filePath = `public/${Date.now()}-${file.name}`;
                        return supabase.storage.from('imagensprodutos').upload(filePath, file);
                    });

                    // Espera todas as promessas de upload serem resolvidas
                    const uploadResults = await Promise.all(uploadPromises);

                    // Pega as URLs públicas de todos os arquivos enviados com sucesso
                    newUploadedUrls = uploadResults.map(result => {
                        if (result.error) {
                            // Se um dos uploads falhar, joga um erro
                            throw new Error(`Falha no upload de uma das imagens da galeria: ${result.error.message}`);
                        }
                        const { data: urlData } = supabase.storage.from('imagensprodutos').getPublicUrl(result.data.path);
                        return urlData.publicUrl;
                    });
                }
                
                // Combina as imagens existentes com as novas
                const finalGalleryUrls = [...existingGalleryUrls, ...newUploadedUrls];

                // 3. Monta o objeto final do produto
                const productData = {
                    name: productNameField.value,
                    details: productDetailsField.value,
                    especificacoes: productSpecsField.value,
                    value: parseFloat(productValueField.value),
                    quantity: parseInt(productQuantityField.value),
                    image: imageUrl,
                    imagens: finalGalleryUrls // Salva o array combinado
                };

                // 4. Salva no banco de dados (lógica mantida)
                let response;
                if (editId) {
                    response = await supabase.from('produtos').update(productData).eq('id', editId);
                } else {
                    response = await supabase.from('produtos').insert([productData]);
                }

                if (response.error) throw response.error;

                alert('Produto salvo com sucesso!');
                window.location.href = 'ADM.html';

            } catch (error) {
                formError.textContent = error.message;
                formError.classList.remove('d-none');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Salvar Produto';
            }
        });

        loadProductForEdit();
    </script>
</body>
</html>