<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - Byte Bros.TI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        body { background-color: #212529; }
        #admin-login-section { min-height: 100vh; }
        .nav-pills .nav-link { cursor: pointer; }
        .stat-card { background-color: #343a40; border-radius: .5rem; padding: 1rem; }
    </style>
</head>
<body>

    <div id="admin-login-section" class="d-flex align-items-center justify-content-center">
        <div class="form-container bg-dark text-light p-4 rounded-3 shadow" style="max-width: 400px;">
            <div class="text-center mb-4">
                <img src="img/bytebros.png" alt="Logo Byte Bros" width="100" class="mb-3">
                <h2>Acesso Restrito</h2>
                <p class="text-muted">Painel de Administração</p>
            </div>
            <form id="admin-login-form">
                <div class="mb-3">
                    <label for="admin-email" class="form-label">Email de Administrador</label>
                    <input type="email" class="form-control" id="admin-email" required>
                </div>
                <div class="mb-3">
                    <label for="admin-password" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="admin-password" required>
                </div>
                <div id="login-error" class="alert alert-danger d-none"></div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </div>
                <div class="mt-3">
                    <a href="index.html" class="btn btn-primary btn-sm">Menu</a>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-dashboard" class="d-none">
        <nav class="navbar navbar-dark bg-dark fixed-top shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Painel Byte Bros.TI</a>
                <div class="d-flex align-items-center">
                    <span id="admin-email-display" class="navbar-text me-3"></span>
                    <button id="admin-logout-btn" class="btn btn-outline-danger btn-sm">Sair</button>
                </div>
            </div>
        </nav>

        <div class="container-fluid" style="margin-top: 70px;">
            <div class="row">
                <div class="col-lg-2">
                    <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-products"><i class="bi bi-box-seam me-2"></i>Produtos</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-news"><i class="bi bi-newspaper me-2"></i>Notícias</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-interactions"><i class="bi bi-headset me-2"></i>Interações</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-clients"><i class="bi bi-people me-2"></i>Clientes</button>
                    </div>
                </div>

                <div class="col-lg-10">
                    <div class="tab-content card bg-dark text-light border-secondary p-4" id="v-pills-tabContent">
                        <div class="tab-pane fade show active" id="v-pills-dashboard"></div>
                        <div class="tab-pane fade" id="v-pills-products"></div>
                        <div class="tab-pane fade" id="v-pills-news"></div>
                        <div class="tab-pane fade" id="v-pills-interactions"></div>
                        <div class="tab-pane fade" id="v-pills-clients"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { supabase } from './js/supabase-client.js';

        const SUPER_ADMIN_USER_ID = '3e88709d-ad2c-4729-958d-73185a162cfa'; 

        const loginSection = document.getElementById('admin-login-section');
        const dashboardSection = document.getElementById('admin-dashboard');
        const loginForm = document.getElementById('admin-login-form');
        const logoutBtn = document.getElementById('admin-logout-btn');
        const adminEmailDisplay = document.getElementById('admin-email-display');
        const loginError = document.getElementById('login-error');
        let allClients = [];
        let currentUserId = null;

        async function checkAdminStatus() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { showLogin(); return; }
            
            currentUserId = session.user.id;

            const { data: user, error } = await supabase.from('usuarios').select('is_admin').eq('id', session.user.id).single();
            if (error || !user || !user.is_admin) {
                await supabase.auth.signOut();
                showLogin();
            } else {
                showDashboard(session.user.email);
                loadTabContent('v-pills-dashboard');
            }
        }

        function showLogin() {
            loginSection.classList.remove('d-none');
            dashboardSection.classList.add('d-none');
            const loginButton = loginForm.querySelector('button[type="submit"]');
            if (loginButton) {
                loginButton.disabled = false;
                loginButton.innerHTML = 'Entrar';
            }
        }

        function showDashboard(email) {
            loginSection.classList.add('d-none');
            dashboardSection.classList.remove('d-none');
            adminEmailDisplay.textContent = email;
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('d-none');
            const btn = e.submitter;
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Entrando...`;
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                loginError.textContent = "Email ou senha inválidos.";
                loginError.classList.remove('d-none');
                btn.disabled = false;
                btn.innerHTML = 'Entrar';
            } else {
                await checkAdminStatus();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            showLogin(); 
        });

        document.querySelectorAll('#v-pills-tab button').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (event) => {
                const targetId = event.target.getAttribute('data-bs-target').substring(1);
                loadTabContent(targetId);
            });
        });

        async function loadTabContent(tabId) {
            const contentArea = document.getElementById(tabId);
            contentArea.innerHTML = `<div class="d-flex justify-content-center"><div class="spinner-border" role="status"></div></div>`;
            try {
                let data, error;
                switch (tabId) {
                    case 'v-pills-dashboard':
                        await renderDashboard(contentArea);
                        break;
                    case 'v-pills-products':
                        ({ data, error } = await supabase.from('produtos').select('*').order('id'));
                        if (error) throw error;
                        renderProducts(contentArea, data);
                        break;
                    case 'v-pills-news':
                        ({ data, error } = await supabase.from('noticias').select('*').order('data', { ascending: false }));
                        if (error) throw error;
                        renderNews(contentArea, data);
                        break;
                    case 'v-pills-interactions':
                        ({ data, error } = await supabase.from('interacoes').select('*').order('criado_em', { ascending: false }));
                        if (error) throw error;
                        renderInteractions(contentArea, data);
                        break;
                    case 'v-pills-clients':
                        ({ data, error } = await supabase.from('usuarios').select('id, nome_completo, email, telefone, is_admin, created_at').order('created_at'));
                        if (error) throw error;
                        allClients = data;
                        renderClients(contentArea);
                        break;
                }
            } catch (err) {
                contentArea.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
            }
        }
        
        async function renderDashboard(container) {
            const { count: clientCount } = await supabase.from('usuarios').select('*', { count: 'exact', head: true });
            const { count: productCount } = await supabase.from('produtos').select('*', { count: 'exact', head: true });
            const { count: interactionCount } = await supabase.from('interacoes').select('*', { count: 'exact', head: true });
            container.innerHTML = `
                <h2>Dashboard</h2>
                <div class="row g-4 mt-2">
                    <div class="col-md-4"><div class="stat-card text-center"><i class="bi bi-people-fill fs-1"></i><h3 class="mt-2">${clientCount ?? 0}</h3><p class="text-muted mb-0">Clientes Cadastrados</p></div></div>
                    <div class="col-md-4"><div class="stat-card text-center"><i class="bi bi-box-seam-fill fs-1"></i><h3 class="mt-2">${productCount ?? 0}</h3><p class="text-muted mb-0">Produtos na Loja</p></div></div>
                    <div class="col-md-4"><div class="stat-card text-center"><i class="bi bi-headset fs-1"></i><h3 class="mt-2">${interactionCount ?? 0}</h3><p class="text-muted mb-0">Interações Recebidas</p></div></div>
                </div>`;
        }

        // --- FUNÇÃO ATUALIZADA ---
        function renderProducts(container, products) {
            let tableHtml = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Produtos Cadastrados</h2>
                    <a href="gerenciar-produto.html" class="btn btn-primary"><i class="bi bi-plus-circle me-2"></i>Adicionar Produto</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover">
                        <thead><tr><th>ID</th><th>Nome</th><th>Preço</th><th>Estoque</th><th>Ações</th></tr></thead>
                        <tbody>`;
            
            products.forEach(p => {
                tableHtml += `
                    <tr>
                        <td>${p.id}</td>
                        <td>${p.name}</td>
                        <td>${parseFloat(p.value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td>${p.quantity}</td>
                        <td>
                            <a href="gerenciar-produto.html?id=${p.id}" class="btn btn-sm btn-outline-warning"><i class="bi bi-pencil-fill"></i></a>
                            <button class="btn btn-sm btn-outline-danger delete-product-btn" data-product-id="${p.id}"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
            });
            
            container.innerHTML = tableHtml + `</tbody></table></div>`;

            container.querySelectorAll('.delete-product-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteProduct);
            });
        }

        async function handleDeleteProduct(event) {
            const productId = event.currentTarget.dataset.productId;
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                const { error } = await supabase.from('produtos').delete().eq('id', productId);
                if (error) {
                    alert('Erro ao excluir produto: ' + error.message);
                } else {
                    alert('Produto excluído com sucesso!');
                    loadTabContent('v-pills-products');
                }
            }
        }

        function renderNews(container, news) {
             let listHtml = '<h2>Notícias Publicadas</h2><p class="text-muted">Funcionalidades de Adicionar/Editar serão implementadas no próximo passo.</p><div class="list-group">';
            news.forEach(n => { listHtml += `<div class="list-group-item list-group-item-dark"><h5>${n.titulo}</h5><p class="mb-1">${n.subtitulo || ''}</p><small class="text-muted">Por ${n.autor || 'N/A'} em ${new Date(n.data).toLocaleDateString()}</small></div>`; });
            container.innerHTML = listHtml + '</div>';
        }

        function renderInteractions(container, interactions) {
            let listHtml = '<h2>Orçamentos e Contatos</h2><p class="text-muted">Funcionalidade de mudança de status será implementada no próximo passo.</p><div class="list-group">';
            interactions.forEach(i => {
                const badgeColor = i.tipo_interacao === 'orcamento' ? 'bg-info text-dark' : 'bg-warning text-dark';
                let typeText = i.tipo_interacao;
                if (i.tipo_interacao === 'orcamento' && i.servico_nome) { typeText += `: <strong class="fw-bold">${i.servico_nome}</strong>`; }
                listHtml += `<div class="list-group-item list-group-item-dark"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">${i.nome} <small>(${i.email})</small></h5><span class="badge ${badgeColor}">${typeText}</span></div><p class="mb-1">${i.mensagem}</p><small class="text-muted">Recebido em: ${new Date(i.criado_em).toLocaleString('pt-BR')}</small></div>`;
            });
            container.innerHTML = listHtml + '</div>';
        }

        function renderClients(container) {
            container.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Clientes Cadastrados</h2>
                    <input type="text" id="client-search" class="form-control w-50" placeholder="Pesquisar por nome ou email...">
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover">
                        <thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Admin</th><th>Ações</th></tr></thead>
                        <tbody id="clients-table-body"></tbody>
                    </table>
                </div>`;
            populateClientTable(allClients);
            document.getElementById('client-search').addEventListener('input', handleClientSearch);
        }

        function populateClientTable(clients) {
            const tableBody = document.getElementById('clients-table-body');
            tableBody.innerHTML = ''; 
            clients.forEach(c => {
                const row = document.createElement('tr');
                const adminCell = document.createElement('td');
                const actionsCell = document.createElement('td');

                const adminButton = document.createElement('button');
                adminButton.textContent = c.is_admin ? 'Sim' : 'Não';
                adminButton.className = `btn btn-sm toggle-admin-btn ${c.is_admin ? 'btn-success' : 'btn-outline-secondary'}`;
                adminButton.addEventListener('click', () => handleToggleAdmin(c.id, c.is_admin));
                adminCell.appendChild(adminButton);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-sm btn-danger delete-client-btn';
                deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                deleteButton.addEventListener('click', () => handleDeleteClient(c.id));
                actionsCell.appendChild(deleteButton);
                
                row.innerHTML = `
                    <td>${c.nome_completo || 'N/A'}</td>
                    <td>${c.email}</td>
                    <td>${c.telefone || 'N/A'}</td>`;
                
                row.appendChild(adminCell);
                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
        }

        function handleClientSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            const filteredClients = allClients.filter(client => 
                (client.nome_completo || '').toLowerCase().includes(searchTerm) || 
                (client.email || '').toLowerCase().includes(searchTerm)
            );
            populateClientTable(filteredClients);
        }

        async function handleDeleteClient(userId) {
            if (currentUserId !== SUPER_ADMIN_USER_ID) {
                alert('Apenas o Super Admin pode excluir usuários.');
                return;
            }
            if (userId === SUPER_ADMIN_USER_ID) {
                alert('Você não pode excluir sua própria conta de Super Admin.');
                return;
            }
            if (confirm('Tem certeza que deseja EXCLUIR este perfil de usuário?')) {
                const { error } = await supabase.from('usuarios').delete().eq('id', userId);
                if (error) { alert('Erro ao excluir perfil: ' + error.message); } 
                else {
                    alert('Perfil de usuário removido.');
                    loadTabContent('v-pills-clients');
                }
            }
        }
        
        async function handleToggleAdmin(userId, currentlyAdmin) {
            if (userId === SUPER_ADMIN_USER_ID) {
                alert('O status do Super Admin não pode ser alterado.');
                return;
            }
            if (confirm(`Deseja ${currentlyAdmin ? 'remover o acesso de' : 'conceder acesso de'} admin para este usuário?`)) {
                 const { error } = await supabase.from('usuarios').update({ is_admin: !currentlyAdmin }).eq('id', userId);
                 if (error) { alert('Erro ao alterar status de admin: ' + error.message); } 
                 else {
                    alert('Status de admin alterado com sucesso!');
                    loadTabContent('v-pills-clients');
                 }
            }
        }
        
        checkAdminStatus();

    </script>
</body>
</html>