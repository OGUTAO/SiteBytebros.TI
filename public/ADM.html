<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - Byte Bros.TI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        body { background-color: #212529; }
        #admin-login-section { min-height: 100vh; }
        .nav-pills .nav-link { cursor: pointer; }
    </style>
</head>
<body>

    <div id="admin-login-section" class="d-flex align-items-center justify-content-center">
        <div class="form-container bg-dark text-light p-4 rounded-3 shadow" style="max-width: 400px;">
            <div class="text-center mb-4">
                <img src="img/bytebros.png" alt="Logo Byte Bros" width="100" class="mb-3">
                <h2>Acesso Restrito</h2>
                <p class="text-muted">Painel de Administração</p>
            </div>
            <form id="admin-login-form">
                <div class="mb-3">
                    <label for="admin-email" class="form-label">Email de Administrador</label>
                    <input type="email" class="form-control" id="admin-email" required>
                </div>
                <div class="mb-3">
                    <label for="admin-password" class="form-label">Senha</label>
                    <input type="password" class="form-control" id="admin-password" required>
                </div>
                <div id="login-error" class="alert alert-danger d-none"></div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">Entrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="admin-dashboard" class="d-none">
        <nav class="navbar navbar-dark bg-dark fixed-top shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Painel Byte Bros.TI</a>
                <div class="d-flex align-items-center">
                    <span id="admin-email-display" class="navbar-text me-3"></span>
                    <button id="admin-logout-btn" class="btn btn-outline-danger btn-sm">Sair</button>
                </div>
            </div>
        </nav>

        <div class="container-fluid" style="margin-top: 70px;">
            <div class="row">
                <div class="col-lg-2">
                    <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#v-pills-dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-products"><i class="bi bi-box-seam me-2"></i>Produtos</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-news"><i class="bi bi-newspaper me-2"></i>Notícias</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-interactions"><i class="bi bi-headset me-2"></i>Interações</button>
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-clients"><i class="bi bi-people me-2"></i>Clientes</button>
                    </div>
                </div>

                <div class="col-lg-10">
                    <div class="tab-content card bg-dark text-light border-secondary p-4" id="v-pills-tabContent">
                        <div class="tab-pane fade show active" id="v-pills-dashboard">
                            <h2>Bem-vindo ao Painel de Controle</h2>
                            <p>Utilize o menu ao lado para gerenciar o conteúdo do site.</p>
                        </div>
                        <div class="tab-pane fade" id="v-pills-products"></div>
                        <div class="tab-pane fade" id="v-pills-news"></div>
                        <div class="tab-pane fade" id="v-pills-interactions"></div>
                        <div class="tab-pane fade" id="v-pills-clients"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { supabase } from './js/supabase-client.js';

        const loginSection = document.getElementById('admin-login-section');
        const dashboardSection = document.getElementById('admin-dashboard');
        const loginForm = document.getElementById('admin-login-form');
        const logoutBtn = document.getElementById('admin-logout-btn');
        const adminEmailDisplay = document.getElementById('admin-email-display');
        const loginError = document.getElementById('login-error');

        // Função para verificar se o usuário logado é um admin
        async function checkAdminStatus() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                showLogin();
                return;
            }

            const { data: user, error } = await supabase
                .from('usuarios')
                .select('is_admin')
                .eq('id', session.user.id)
                .single();

            if (error || !user || !user.is_admin) {
                // Não mostra o alerta, apenas desloga silenciosamente
                await supabase.auth.signOut();
                showLogin();
            } else {
                showDashboard(session.user.email);
            }
        }

        function showLogin() {
            loginSection.classList.remove('d-none');
            dashboardSection.classList.add('d-none');
        }

        function showDashboard(email) {
            loginSection.classList.add('d-none');
            dashboardSection.classList.remove('d-none');
            adminEmailDisplay.textContent = email;
        }

        // Evento de submit do formulário de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('d-none');
            const btn = e.submitter;
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Entrando...`;

            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                loginError.textContent = "Email ou senha inválidos."; // Mensagem mais amigável
                loginError.classList.remove('d-none');
                btn.disabled = false;
                btn.innerHTML = 'Entrar';
            } else {
                // Após o login, verifica se é admin. A função checkAdminStatus cuida de mostrar a tela certa.
                await checkAdminStatus();
            }
        });

        // Evento de logout
        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            // A função showLogin() vai esconder o painel e mostrar o form de login
            showLogin(); 
        });

        // Carrega o conteúdo da aba quando ela é mostrada
        document.querySelectorAll('#v-pills-tab button').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (event) => {
                const targetId = event.target.getAttribute('data-bs-target').substring(1);
                loadTabContent(targetId);
            });
        });

        // Função para carregar o conteúdo das abas
        async function loadTabContent(tabId) {
            const contentArea = document.getElementById(tabId);
            const spinner = `<div class="d-flex justify-content-center"><div class="spinner-border" role="status"></div></div>`;
            contentArea.innerHTML = spinner;

            try {
                let data, error;
                switch (tabId) {
                    case 'v-pills-products':
                        ({ data, error } = await supabase.from('produtos').select('*').order('id'));
                        if (error) throw error;
                        renderProducts(contentArea, data);
                        break;
                    case 'v-pills-news':
                         ({ data, error } = await supabase.from('noticias').select('*').order('created_at', { ascending: false }));
                        if (error) throw error;
                        renderNews(contentArea, data);
                        break;
                    case 'v-pills-interactions':
                         ({ data, error } = await supabase.from('interacoes').select('*').order('created_at', { ascending: false }));
                        if (error) throw error;
                        renderInteractions(contentArea, data);
                        break;
                    case 'v-pills-clients':
                         ({ data, error } = await supabase.from('usuarios').select('id, nome_completo, email, telefone, is_admin').order('created_at'));
                        if (error) throw error;
                        renderClients(contentArea, data);
                        break;
                    case 'v-pills-dashboard':
                        // O conteúdo do dashboard é estático, não precisa de spinner
                        contentArea.innerHTML = `<h2>Bem-vindo ao Painel de Controle</h2><p>Utilize o menu ao lado para gerenciar o conteúdo do site.</p>`;
                        break;
                }
            } catch (err) {
                contentArea.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
            }
        }

        // Funções de Renderização
        function renderProducts(container, products) {
            let tableHtml = `<h2>Produtos Cadastrados</h2><div class="table-responsive"><table class="table table-dark table-striped table-hover"><thead><tr><th>ID</th><th>Nome</th><th>Preço</th><th>Estoque</th></tr></thead><tbody>`;
            products.forEach(p => {
                tableHtml += `<tr><td>${p.id}</td><td>${p.name}</td><td>${parseFloat(p.value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td>${p.quantity}</td></tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table></div>`;
        }

        function renderNews(container, news) {
             let listHtml = '<h2>Notícias Publicadas</h2><div class="list-group">';
            news.forEach(n => {
                listHtml += `<div class="list-group-item list-group-item-dark"><h5>${n.titulo}</h5><p class="mb-1">${n.subtitulo || ''}</p><small class="text-muted">Por ${n.autor || 'N/A'} em ${new Date(n.data).toLocaleDateString()}</small></div>`;
            });
            container.innerHTML = listHtml + '</div>';
        }

        function renderInteractions(container, interactions) {
            let listHtml = '<h2>Orçamentos e Contatos</h2><div class="list-group">';
            interactions.forEach(i => {
                const badgeColor = i.tipo_interacao === 'orcamento' ? 'bg-info text-dark' : 'bg-warning text-dark';
                listHtml += `<div class="list-group-item list-group-item-dark"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">${i.nome} <small>(${i.email})</small></h5><span class="badge ${badgeColor}">${i.tipo_interacao}</span></div><p class="mb-1">${i.mensagem}</p><small class="text-muted">Recebido em: ${new Date(i.created_at).toLocaleString('pt-BR')}</small></div>`;
            });
            container.innerHTML = listHtml + '</div>';
        }

        function renderClients(container, clients) {
            let tableHtml = `<h2>Clientes Cadastrados</h2><div class="table-responsive"><table class="table table-dark table-striped table-hover"><thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Admin</th></tr></thead><tbody>`;
            clients.forEach(c => {
                 tableHtml += `<tr><td>${c.nome_completo}</td><td>${c.email}</td><td>${c.telefone || 'N/A'}</td><td>${c.is_admin ? 'Sim' : 'Não'}</td></tr>`;
            });
            container.innerHTML = tableHtml + `</tbody></table></div>`;
        }

        // Verificação inicial ao carregar a página
        checkAdminStatus();

    </script>
</body>
</html>